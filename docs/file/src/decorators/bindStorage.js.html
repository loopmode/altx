<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/decorators/bindStorage.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ImmutableStore.js~ImmutableStore.html">ImmutableStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-BindHandlers">BindHandlers</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-resetStores">resetStores</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getAltInstance">getAltInstance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setAltInstance">setAltInstance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setup">setup</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-callFactory">callFactory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-callSeries">callSeries</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createAction">createAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createActions">createActions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createStore">createStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getSources">getSources</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-handlerFactory">handlerFactory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-withDecorators">withDecorators</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">decorators</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-bindActions">bindActions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-bindCalls">bindCalls</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-bindHandlers">bindHandlers</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-bindStorage">bindStorage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-connect">connect</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-connectAlternative">connectAlternative</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-flatten">flatten</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createLogger">createLogger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getLevel">getLevel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setLevel">setLevel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-logLevel">logLevel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils/validate</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-creatorConstraints">creatorConstraints</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-validateCreator">validateCreator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-definitionConstraints">definitionConstraints</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-validateDefinition">validateDefinition</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-handlerConstraints">handlerConstraints</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-validateHandler">validateHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-loggerConstraints">loggerConstraints</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/decorators/bindStorage.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import Immutable from &apos;immutable&apos;;
import Events from &apos;@loopmode/events&apos;;

/**
 * Decorator for ImmutableStore to persist values across browser refresh.
 *
 * Supports `window.localStorage` and `window.sessionStorage` as well as `localForage` or any other backend that implements the [Web Storage API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API).
 * The storage backend may return promises for asynchronous usage.
 *
 * To store only specific parts of the state, provide a `keyPaths` array. Omit `keyPaths` to persist the entire state of the store.
 *
 * @param {Object} options
 * @param {Array&lt;Array|String&gt;} [options.keyPaths] - An array of keyPaths. Each keyPath can be an array of strings as used in Immutable.js, e.g. `[&apos;foo&apos;, &apos;bar&apos;]` or a string with dot delimiters, e.g. `&apos;foo.bar&apos;`
 * @param {Object} [options.storage=window.localStorage] - An object that supports the [Web Storage API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API) methods
 * @param {Function} [options.parse] - A function that receives the persisted value and returns the data object. Defaults to `JSON.parse` if `storage` is an instance of `window.Storage`
 * @param {Function} [options.encode] - A function that receives the data object and returns the value to be persisted. Defaults to `JSON.stringify` if `storage` is an instance of `window.Storage`
 * @param {Boolean} [options.logging] - Whether to log details to the console during operations
 * @return {Function} - The decorator function for the target store
 */
export default function bindStorage({ storage, keyPaths, parse, encode, logging } = {}) {
    if (typeof window === &apos;undefined&apos;) {
        return StoreClass =&gt; StoreClass;
    }

    storage = storage || window.localStorage;
    if (storage instanceof window.Storage) {
        parse = parse || JSON.parse;
        encode = encode || JSON.stringify;
    }
    return function decorate(StoreClass) {
        return class PersistableStore extends StoreClass {
            constructor(model) {
                super(model);
                this.persistenceEnable({ storage, keyPaths });
                this.exportPublicMethods({
                    persistenceEnable: () =&gt; this.persistenceEnable({ storage, keyPaths }),
                    persistenceDisable: () =&gt; this.persistenceDisable(),
                    persistenceClear: () =&gt; this.persistenceClear()
                });
            }

            persistenceEnable = ({ storage, keyPaths }) =&gt; {
                this.persistenceConfig = {
                    storage,
                    name: `persisted.${this.displayName}`,
                    keyPaths:
                        keyPaths &amp;&amp;
                        keyPaths.map(keyPath =&gt; {
                            if (typeof keyPath === &apos;string&apos;) return keyPath.split(&apos;.&apos;);
                            return keyPath;
                        })
                };

                if (logging) {
                    console.log(&apos;[PersistableStore] persistenceEnable&apos;, { store: this });
                }

                Events.on(&apos;beforeunload&apos;, this.persistenceBeforeUnload);

                this.persistenceRestore();
            };
            persistenceBeforeUnload = () =&gt; {
                this.persistenceSave();
            };
            persistenceDisable = () =&gt; {
                if (logging) {
                    console.log(&apos;[PersistableStore] persistenceDisable&apos;, { store: this });
                }

                Events.off(&apos;beforeunload&apos;, this.persistenceBeforeUnload);
            };
            persistenceClear = () =&gt; {
                this.initialData = this._initialDataWithoutPersistence || this.initialData;
                const { storage, name } = this.persistenceConfig;
                this.persistenceDisable();
                storage.removeItem(name);
                console.log(`[PersistableStore] &quot;${name}&quot; cleared. Please refresh the window`);
            };
            persistenceRestore = async () =&gt; {
                try {
                    const { storage, name } = this.persistenceConfig;
                    let data = await storage.getItem(name);
                    if (data) {
                        if (parse) data = parse(data);

                        data = Immutable.fromJS(data);
                        this.persistenceExtendInitialData(data);

                        const nextState = this.state.mergeDeep(data);

                        if (logging) {
                            console.log(&apos;[PersistableStore] persistenceRestore&apos;, { store: this, data, nextState });
                        }

                        this.setState(nextState);
                    }
                } catch (error) {
                    console.warn(&apos;[PersistableStore] persistenceRestore failed&apos;, { error, store: this });
                }
            };
            persistenceSave = async () =&gt; {
                try {
                    const { storage, name, keyPaths } = this.persistenceConfig;
                    let data = this.state;

                    if (keyPaths &amp;&amp; keyPaths.length) {
                        data = keyPaths.reduce(
                            (result, keyPath) =&gt; result.setIn(keyPath, this.state.getIn(keyPath)),
                            Immutable.fromJS({})
                        );
                    }

                    data = data.toJS();

                    if (encode) data = encode(data);

                    if (logging) {
                        console.log(&apos;[PersistableStore] persistenceRestore&apos;, { store: this, data });
                    }

                    await storage.setItem(name, data);
                } catch (error) {
                    console.warn(&apos;[PersistableStore] persistenceSave failed&apos;, { error, store: this });
                }
            };
            persistenceExtendInitialData = persistedData =&gt; {
                if (!this.initialData) {
                    return;
                }
                const wasImmutable = typeof this.initialData.toJS === &apos;function&apos;;
                this._initialDataWithoutPersistence = this.initialData;
                this.initialData = Immutable.fromJS(this.initialData).mergeDeep(persistedData);
                if (!wasImmutable) {
                    this.initialData = this.initialData.toJS();
                }
            };
        };
    };
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
